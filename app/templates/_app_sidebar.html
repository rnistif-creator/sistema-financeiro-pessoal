<!-- PWA Meta Tags -->
<meta name="theme-color" content="#22d3ee">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Financeiro">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
<link rel="manifest" href="/static/manifest.json">
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/static/icons/domo360-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/static/icons/domo360-16x16.png">
<link rel="icon" type="image/png" sizes="192x192" href="/static/icons/domo360-192x192.png">
<link rel="apple-touch-icon" href="/static/icons/domo360-180x180.png">
<link rel="apple-touch-icon" sizes="152x152" href="/static/icons/domo360-152x152.png">
<link rel="apple-touch-icon" sizes="144x144" href="/static/icons/domo360-144x144.png">

<!-- Configura√ß√£o Global -->
<script src="/static/config.js?v=20251105b"></script>

<!-- Componentes de Feedback Visual e Acessibilidade -->
<link rel="stylesheet" href="/static/components.css?v=20251105d">
<script src="/static/components.js?v=20251105d"></script>
<!-- Delega√ß√£o de Eventos (remove necessidade de handlers inline) -->
<script src="/static/events.js?v=20251107a"></script>

<!-- Skip to Content Link (Acessibilidade) -->
<a href="#main-content" class="skip-to-content">Pular para o conte√∫do principal</a>

<!-- Sidebar de Navega√ß√£o Global -->
<style>
  .app-nav-button{
    position: fixed; top: 16px; left: 16px; z-index: 1100;
    padding: 10px 12px; border-radius: 10px;
    border: 1px solid rgba(148,163,184,0.25);
    background: rgba(15,23,42,0.55); color: var(--text);
    cursor: pointer; font-weight: 600;
  }
  
  /* Bot√£o de Notifica√ß√µes */
  .notification-button {
    position: fixed; top: 16px; right: 16px; z-index: 1100;
    padding: 10px 12px; border-radius: 10px;
    border: 1px solid rgba(148,163,184,0.25);
    background: rgba(15,23,42,0.55); color: var(--text);
    cursor: pointer; font-weight: 600;
    font-size: 20px;
    display: flex; align-items: center; gap: 8px;
  }
  .notification-button:hover {
    background: rgba(15,23,42,0.75);
  }
  .notification-badge {
    background: #ef4444;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
  }
  
  /* Dropdown de Notifica√ß√µes */
  .notification-dropdown {
    position: fixed;
    top: 70px;
    right: 16px;
    width: 380px;
    max-width: calc(100vw - 32px);
    max-height: 500px;
    background: var(--card);
    border: 1px solid rgba(148,163,184,0.2);
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    z-index: 1099;
    display: none;
    flex-direction: column;
  }
  .notification-dropdown.show {
    display: flex;
  }
  .notification-header {
    padding: 16px;
    border-bottom: 1px solid rgba(148,163,184,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .notification-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
  }
  .notification-list {
    overflow-y: auto;
    flex: 1;
  }
  .notification-item {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(148,163,184,0.08);
    cursor: pointer;
    transition: background 0.2s;
  }
  .notification-item:hover {
    background: rgba(148,163,184,0.05);
  }
  .notification-item.vencida {
    border-left: 3px solid #ef4444;
    background: rgba(239, 68, 68, 0.05);
  }
  .notification-item.vence_hoje {
    border-left: 3px solid #f59e0b;
    background: rgba(245, 158, 11, 0.05);
  }
  .notification-item.vence_proximamente {
    border-left: 3px solid #3b82f6;
    background: rgba(59, 130, 246, 0.05);
  }
  .notification-title {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .notification-message {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 4px;
  }
  .notification-value {
    font-size: 14px;
    font-weight: 600;
    color: var(--primary);
  }
  .notification-empty {
    padding: 40px 16px;
    text-align: center;
    color: var(--muted);
  }
  .notification-footer {
    padding: 12px 16px;
    border-top: 1px solid rgba(148,163,184,0.1);
    text-align: center;
  }
  .notification-footer a {
    color: var(--primary);
    text-decoration: none;
    font-size: 14px;
    font-weight: 600;
  }
  .notification-footer a:hover {
    text-decoration: underline;
  }
  
  #navOverlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:1090; }
  #appSidebar{
    position:fixed; top:0; left:0; bottom:0; width:260px; max-width:90vw;
    background: var(--card); color: var(--text);
    border-right: 1px solid rgba(148,163,184,0.15);
    transform: translateX(-100%); transition: transform .25s ease; z-index: 1100;
    display:flex; flex-direction:column;
  }
  #appSidebar .side-header{ display:flex; align-items:center; justify-content:space-between; padding:16px; border-bottom:1px solid rgba(148,163,184,0.12); }
  #appSidebar .side-header strong{ font-size: 16px; }
  #appSidebar .side-close{ background:transparent; color:var(--text); border:none; font-size:20px; cursor:pointer; }
  #appSidebar nav{ padding:10px 8px; overflow:auto; }
  #appSidebar a{
    display:flex; align-items:center; gap:10px; text-decoration:none;
    color: var(--text); padding:10px 12px; border-radius:8px;
  }
  #appSidebar a:hover{ background: rgba(148,163,184,0.12); }
  #appSidebar a.active{
    background: rgba(34,211,238,0.12);
    border-left: 3px solid var(--primary);
  }
  #appSidebar .section-title{ padding: 10px 12px; color: var(--muted); font-weight:700; font-size:12px; text-transform: uppercase; letter-spacing: .6px; }
  
  @media (max-width: 640px){ 
    .app-nav-button{ top: 12px; left: 12px; }
    .notification-button { top: 12px; right: 12px; }
    .notification-dropdown { 
      top: 60px; 
      right: 12px;
      left: 12px;
      width: auto;
    }
  }

  /* Docked layout on desktop */
  @media (min-width: 1024px){
    #appSidebar{ transform: translateX(0) !important; }
    #navOverlay{ display: none !important; }
    .app-nav-button{ display: none !important; }
    body > .container{ margin-left: 260px; }
  }

  /* Barra de status da assinatura */
  .billing-status {
    position: fixed;
    top: 66px;
    right: 16px;
    z-index: 1085;
    background: var(--card);
    color: var(--text);
    border: 1px solid rgba(148,163,184,0.2);
    border-left-width: 3px;
    padding: 10px 12px;
    border-radius: 10px;
    min-width: 240px;
    display: none;
  }
  .billing-status.show { display: block; }
  .billing-status .title { font-size: 13px; font-weight: 700; margin-bottom: 4px; }
  .billing-status .desc { font-size: 12px; color: var(--muted); }
  .billing-status .actions { margin-top: 8px; display: flex; gap: 8px; }
  .billing-status .btn {
    padding: 8px 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 12px;
  }
  .billing-status .btn-primary { background: linear-gradient(135deg, #22d3ee, #06b6d4); color: #001018; }
  .billing-status .btn-outline { background: transparent; color: var(--text); border: 1px solid rgba(148,163,184,0.3); }
  .billing-status.trial { border-left-color: #06b6d4; }
  .billing-status.ativa { border-left-color: #22c55e; }
  .billing-status.inadimplente { border-left-color: #ef4444; }
  .billing-status.cancelada { border-left-color: #9ca3af; }
  .billing-status .mini-form { margin-top: 8px; display: none; gap: 6px; align-items: center; }
  .billing-status .mini-form input, .billing-status .mini-form select {
    background: rgba(2,6,23,0.6); color: var(--text); border: 1px solid rgba(148,163,184,0.25); border-radius: 8px; padding: 6px 8px; font-size: 12px;
  }
  .billing-status .mini-form .btn-confirm { padding: 6px 10px; border-radius: 8px; border: none; background: #22c55e; color: #001018; font-weight: 700; cursor: pointer; }
</style>

<!-- Bot√£o de Menu -->
<button id="btnOpenAppSidebar" class="app-nav-button">‚ò∞ Menu</button>

<!-- Bot√£o de Notifica√ß√µes -->
<button id="btnNotifications" class="notification-button" aria-label="Notifica√ß√µes" title="Notifica√ß√µes">
  üîî
  <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
</button>

<!-- Barra de Status da Assinatura -->
<div id="billingStatus" class="billing-status" aria-live="polite"></div>

<!-- Dropdown de Notifica√ß√µes -->
<div id="notificationDropdown" class="notification-dropdown">
  <div class="notification-header">
    <h3>üîî Notifica√ß√µes</h3>
    <button id="btnCloseNotifications" style="background: transparent; border: none; color: var(--text); cursor: pointer; font-size: 18px;">‚úï</button>
  </div>
  <div class="notification-list" id="notificationList">
    <div class="notification-empty">
      <div style="font-size: 48px; margin-bottom: 8px;">üîî</div>
      <div>Carregando notifica√ß√µes...</div>
    </div>
  </div>
  <div class="notification-footer">
    <a href="/parcelas">Ver todas as parcelas ‚Üí</a>
  </div>
</div>

<div id="navOverlay" aria-hidden="true"></div>
<aside id="appSidebar" role="navigation" aria-label="Menu principal">
  <div class="side-header">
    <strong>üíº Financeiro</strong>
    <button id="btnCloseAppSidebar" class="side-close" aria-label="Fechar">‚úï</button>
  </div>
  <nav>
    <div class="section-title">Geral</div>
    <a href="/dashboard">üìà Dashboard</a>
    <a href="/lancamentos">üè† Lan√ßamentos</a>
    <a href="/parcelas">üìÖ Parcelas</a>
    <a href="/fluxo-caixa">üìä Fluxo de Caixa</a>
    <a href="/tipos">üè∑Ô∏è Tipos</a>
    <a href="/metas">üéØ Metas</a>
    <a href="/formas-pagamento">üí≥ Formas de Pagamento</a>
    <a href="/historico-pagamentos">üíµ Hist√≥rico de Pagamentos</a>
    <div class="section-title">Sistema</div>
    <a href="/configuracoes">‚öôÔ∏è Configura√ß√µes</a>
  <a href="#" data-action="tryInstallPWA">üì± Instalar App</a>
  <a href="/login" data-action="sairDoSistema" style="color: #ef4444;">üö™ Sair</a>
  </nav>
</aside>
<script{%- if csp_nonce %} nonce="{{ csp_nonce }}"{%- endif %}>
  (function(){
    function toggleNav(open){
      const sb=document.getElementById('appSidebar');
      const ov=document.getElementById('navOverlay');
      if(open){ sb.style.transform='translateX(0)'; ov.style.display='block'; ov.setAttribute('aria-hidden','false'); }
      else { sb.style.transform='translateX(-100%)'; ov.style.display='none'; ov.setAttribute('aria-hidden','true'); }
    }
    const openBtn=document.getElementById('btnOpenAppSidebar');
    const closeBtn=document.getElementById('btnCloseAppSidebar');
    const overlay=document.getElementById('navOverlay');
    if(openBtn) openBtn.addEventListener('click', ()=> toggleNav(true));
    if(closeBtn) closeBtn.addEventListener('click', ()=> toggleNav(false));
    if(overlay) overlay.addEventListener('click', ()=> toggleNav(false));
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') toggleNav(false); });

    // Active link highlight
    try{
      const path = window.location.pathname.replace(/\/$/, '') || '/';
      const links = document.querySelectorAll('#appSidebar nav a');
      links.forEach(a=>{
        const href = (a.getAttribute('href')||'').replace(/\/$/, '') || '/';
        if(href === '/'){
          if(path === '/') { a.classList.add('active'); a.setAttribute('aria-current','page'); }
        } else if (path.startsWith(href)) {
          a.classList.add('active'); a.setAttribute('aria-current','page');
        }
      });
    }catch(_e){}
  })();
</script>

<!-- Sistema de Notifica√ß√µes -->
<script{%- if csp_nonce %} nonce="{{ csp_nonce }}"{%- endif %}>
(function() {
  let notificacoesData = null;
  let notificationCheckInterval = null;

  // Buscar notifica√ß√µes
  async function buscarNotificacoes() {
    try {
      const response = await fetch(`${API_BASE}/api/notificacoes`);
      if (!response.ok) throw new Error('Erro ao buscar notifica√ß√µes');
      
      notificacoesData = await response.json();
      atualizarBadge();
      
      // Solicitar permiss√£o para notifica√ß√µes do navegador
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
      
      // Enviar notifica√ß√£o do navegador para itens cr√≠ticos
      enviarNotificacoesCriticas();
      
    } catch (error) {
      console.error('Erro ao buscar notifica√ß√µes:', error);
    }
  }

  // Atualizar badge do bot√£o
  function atualizarBadge() {
    const badge = document.getElementById('notificationBadge');
    if (!notificacoesData || notificacoesData.total === 0) {
      badge.style.display = 'none';
      return;
    }
    
    badge.textContent = notificacoesData.total > 99 ? '99+' : notificacoesData.total;
    badge.style.display = 'flex';
  }

  // Renderizar lista de notifica√ß√µes
  function renderizarNotificacoes() {
    const lista = document.getElementById('notificationList');
    
    if (!notificacoesData || notificacoesData.notificacoes.length === 0) {
      lista.innerHTML = `
        <div class="notification-empty">
          <div style="font-size: 48px; margin-bottom: 8px;">‚úÖ</div>
          <div>Nenhuma notifica√ß√£o</div>
          <div style="font-size: 12px; margin-top: 4px;">Voc√™ est√° em dia!</div>
        </div>
      `;
      return;
    }
    
    lista.innerHTML = notificacoesData.notificacoes.map(n => `
      <div class="notification-item ${n.tipo}" data-onclick="irParaParcela(${n.id})">
        <div class="notification-title">
          <span>${n.titulo}</span>
          <span style="font-size: 12px; color: var(--muted);">${formatarDataBR(n.data_vencimento)}</span>
        </div>
        <div class="notification-message">
          ${getIconePrioridade(n.prioridade)} ${n.mensagem}
        </div>
        <div class="notification-value">
          ${n.natureza === 'receita' ? 'üí∞' : 'üí∏'} ${brl(n.valor)}
        </div>
      </div>
    `).join('');
  }

  // √çcone de prioridade
  function getIconePrioridade(prioridade) {
    switch(prioridade) {
      case 'alta': return 'üî¥';
      case 'media': return 'üü°';
      case 'baixa': return 'üîµ';
      default: return '‚ö™';
    }
  }

  // Formatar data BR
  function formatarDataBR(dataISO) {
    const [ano, mes, dia] = dataISO.split('-');
    return `${dia}/${mes}/${ano}`;
  }

  // Ir para a p√°gina de parcelas
  window.irParaParcela = function(parcelaId) {
    window.location.href = `/parcelas?highlight=${parcelaId}`;
  };

  // Enviar notifica√ß√µes cr√≠ticas do navegador
  function enviarNotificacoesCriticas() {
    if (!notificacoesData || Notification.permission !== 'granted') return;
    
    const criticas = notificacoesData.notificacoes.filter(n => 
      n.tipo === 'vencida' || n.tipo === 'vence_hoje'
    );
    
    if (criticas.length > 0 && !sessionStorage.getItem('notificacoes_enviadas_hoje')) {
      const vencidas = criticas.filter(n => n.tipo === 'vencida').length;
      const hoje = criticas.filter(n => n.tipo === 'vence_hoje').length;
      
      let mensagem = '';
      if (vencidas > 0) mensagem += `${vencidas} parcela(s) vencida(s)`;
      if (hoje > 0) mensagem += `${vencidas > 0 ? ' e ' : ''}${hoje} vence(m) hoje`;
      
      new Notification('‚ö†Ô∏è Aten√ß√£o - Parcelas Pendentes', {
        body: mensagem,
        icon: '/static/favicon.ico',
        badge: '/static/favicon.ico',
        tag: 'parcelas-pendentes'
      });
      
      sessionStorage.setItem('notificacoes_enviadas_hoje', 'true');
    }
  }

  // Toggle dropdown
  const btnNotifications = document.getElementById('btnNotifications');
  const dropdown = document.getElementById('notificationDropdown');
  const btnClose = document.getElementById('btnCloseNotifications');
  const navOverlay = document.getElementById('navOverlay');
  
  function toggleDropdown(show) {
    if (show) {
      renderizarNotificacoes();
      dropdown.classList.add('show');
      navOverlay.style.display = 'block';
    } else {
      dropdown.classList.remove('show');
      if (!document.getElementById('appSidebar').style.transform.includes('translateX(0)')) {
        navOverlay.style.display = 'none';
      }
    }
  }
  
  btnNotifications.addEventListener('click', () => {
    const isOpen = dropdown.classList.contains('show');
    toggleDropdown(!isOpen);
  });
  
  btnClose.addEventListener('click', () => toggleDropdown(false));
  
  navOverlay.addEventListener('click', () => {
    toggleDropdown(false);
  });

  // Buscar notifica√ß√µes ao carregar
  buscarNotificacoes();
  
  // Atualizar a cada 5 minutos
  notificationCheckInterval = setInterval(buscarNotificacoes, 5 * 60 * 1000);
  
  // Limpar intervalo ao sair
  window.addEventListener('beforeunload', () => {
    if (notificationCheckInterval) clearInterval(notificationCheckInterval);
  });
})();
</script>

<!-- Status da Assinatura (Billing) -->
<script{%- if csp_nonce %} nonce="{{ csp_nonce }}"{%- endif %}>
(function(){
  const el = document.getElementById('billingStatus');
  if (!el) return;

  async function carregarAssinatura() {
    try {
      const resp = await fetch(`${API_BASE}/api/billing/assinatura`);
      if (!resp.ok) throw new Error('Falha ao obter assinatura');
      const data = await resp.json();
      render(data);
    } catch (e) {
      // Em caso de erro (ex: usu√°rio n√£o autenticado em alguma rota p√∫blica), esconder
      el.classList.remove('show');
    }
  }

  function toBR(iso) {
    if (!iso) return '';
    const [y,m,d] = iso.split('-');
    return `${d}/${m}/${y}`;
  }

  function diffDias(iso) {
    if (!iso) return null;
    const hoje = new Date(); hoje.setHours(0,0,0,0);
    const [y,m,d] = iso.split('-').map(Number);
    const dt = new Date(y, m-1, d);
    const diffMs = dt - hoje;
    return Math.round(diffMs / (1000*60*60*24));
  }

  function render(data) {
    const { status, proximo_vencimento, trial_ate } = data;
    let html = '';
    el.className = `billing-status ${status} show`;

    if (status === 'trial') {
      const dias = diffDias(trial_ate);
      html = `
        <div class="title">üéÅ Avalia√ß√£o (TRIAL)</div>
        <div class="desc">V√°lida at√© <strong>${toBR(trial_ate) || '-'}</strong>${Number.isFinite(dias) ? ` (${dias} dia(s) restante(s))` : ''}.</div>
        <div class="actions">
          <a class="btn btn-outline" href="/configuracoes">Configura√ß√µes</a>
        </div>
      `;
    } else if (status === 'ativa') {
      html = `
        <div class="title">‚úÖ Assinatura ativa</div>
        <div class="desc">Pr√≥ximo vencimento: <strong>${toBR(proximo_vencimento) || '-'}</strong></div>
        <div class="actions">
          <a class="btn btn-outline" href="/configuracoes">Gerenciar</a>
        </div>
      `;
    } else if (status === 'inadimplente') {
      html = `
        <div class="title">‚ö†Ô∏è Assinatura vencida</div>
        <div class="desc">Venceu em <strong>${toBR(proximo_vencimento) || '-'}</strong>. Regularize para continuar usando todos os recursos.</div>
        <div class="actions">
          <button class="btn btn-primary" id="btnAbrirPagamento">Registrar pagamento</button>
          <a class="btn btn-outline" href="/configuracoes">Op√ß√µes</a>
        </div>
        <div class="mini-form" id="miniFormPagamento">
          <input id="inputValorPg" type="number" step="0.01" min="0" placeholder="Valor (R$)" style="width: 110px;" />
          <select id="inputMetodoPg">
            <option value="manual">Manual</option>
            <option value="pix">PIX</option>
            <option value="boleto">Boleto</option>
            <option value="cartao">Cart√£o</option>
          </select>
          <button class="btn-confirm" id="btnConfirmarPg">Confirmar</button>
        </div>
      `;
    } else if (status === 'cancelada') {
      html = `
        <div class="title">‚èπÔ∏è Assinatura cancelada</div>
        <div class="desc">Reative sua assinatura para continuar.</div>
        <div class="actions">
          <a class="btn btn-primary" href="/configuracoes">Reativar</a>
        </div>
      `;
    } else {
      // desconhecido: ocultar
      el.classList.remove('show');
      return;
    }

    el.innerHTML = html;

    // Comportamento do fluxo de pagamento simples
    const btnAbrir = document.getElementById('btnAbrirPagamento');
    const miniForm = document.getElementById('miniFormPagamento');
    const btnConfirmar = document.getElementById('btnConfirmarPg');
    if (btnAbrir && miniForm) {
      btnAbrir.addEventListener('click', () => {
        miniForm.style.display = miniForm.style.display === 'flex' ? 'none' : 'flex';
      });
    }
    if (btnConfirmar) {
      btnConfirmar.addEventListener('click', async () => {
        try {
          const raw = document.getElementById('inputValorPg').value;
          const valor = window.parseNumber ? window.parseNumber(raw) : Number(raw);
          const metodo = document.getElementById('inputMetodoPg').value || 'manual';
          if (!valor || valor <= 0) { throw new Error('Informe um valor v√°lido.'); }
          const r = await fetch(`${API_BASE}/api/billing/pagamentos`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ valor, metodo })
          });
          if (!r.ok) {
            const j = await r.json().catch(()=>({detail:'Falha ao registrar pagamento'}));
            throw new Error(typeof j.detail === 'string' ? j.detail : (j.detail?.message || 'Falha ao registrar pagamento'));
          }
          if (window.Toast) Toast.success('Pagamento registrado com sucesso!');
          miniForm.style.display = 'none';
          await carregarAssinatura();
        } catch (err) {
          console.error(err);
          if (window.Toast) Toast.error(err.message || 'Erro ao registrar pagamento');
          else alert(err.message || 'Erro ao registrar pagamento');
        }
      });
    }
  }

  // Inicializar e atualizar periodicamente
  carregarAssinatura();
  setInterval(carregarAssinatura, 5 * 60 * 1000);
})();
</script>

<!-- Logout do Sistema -->
<script{%- if csp_nonce %} nonce="{{ csp_nonce }}"{%- endif %}>
async function sairDoSistema() {
  if (!confirm('Deseja realmente sair do sistema?')) return;
  
  try {
    const resp = await fetch(`${API_BASE}/auth/logout`, { method: 'POST' });
    if (resp.ok) {
      if (window.Toast) Toast.success('Logout realizado com sucesso!');
      setTimeout(() => window.location.href = '/login', 500);
    } else {
      throw new Error('Falha ao fazer logout');
    }
  } catch (e) {
    console.error(e);
    if (window.Toast) Toast.error('Erro ao fazer logout');
    // For√ßar redirect mesmo se falhar
    setTimeout(() => window.location.href = '/login', 1000);
  }
}
</script>

<!-- Sess√£o: aviso 1 min antes e logout autom√°tico aos 30 min -->
<script{%- if csp_nonce %} nonce="{{ csp_nonce }}"{%- endif %}>
(function(){
  let warned = false;
  let warnTimer = null;
  let logoutTimer = null;
  let countdownInterval = null;

  async function scheduleFromServer() {
    try{
      const r = await fetch(`${API_BASE}/auth/session-remaining`, { credentials: 'same-origin' });
      if(!r.ok){
        if(r.status === 401){
          await doAutoLogout();
          return;
        }
        return;
      }
      const j = await r.json();
      const seconds = Number(j?.seconds || 0);
      clearTimers();
      if(seconds <= 0){
        // expirado
        await doAutoLogout();
        return;
      }
      
      // Mostrar contagem regressiva se restam < 2 minutos
      if(seconds < 120){
        showCountdownBanner(seconds);
      } else {
        hideCountdownBanner();
      }
      
      // agendar aviso 1 min antes
      const warnIn = Math.max(0, (seconds - 60) * 1000);
      const logoutIn = seconds * 1000;
      warnTimer = setTimeout(()=>{
        if(!warned){
          warned = true;
          const msg = 'Sua sess√£o vai expirar em 1 minuto. Salve seu trabalho.';
          if(window.Toast) Toast.warning(msg); else alert(msg);
        }
      }, warnIn);
      logoutTimer = setTimeout(()=>{ doAutoLogout(); }, logoutIn);
    }catch(e){ /* silencioso */ }
  }

  function clearTimers(){
    if(warnTimer){ clearTimeout(warnTimer); warnTimer = null; }
    if(logoutTimer){ clearTimeout(logoutTimer); logoutTimer = null; }
    if(countdownInterval){ clearInterval(countdownInterval); countdownInterval = null; }
  }

  function showCountdownBanner(seconds){
    let banner = document.getElementById('sessionCountdownBanner');
    if(!banner){
      banner = document.createElement('div');
      banner.id = 'sessionCountdownBanner';
      banner.style.cssText = 'position:fixed; top:0; left:0; right:0; z-index:9998; background:linear-gradient(135deg, #f59e0b, #dc2626); color:#fff; padding:10px 16px; text-align:center; font-weight:700; font-size:14px; box-shadow:0 2px 8px rgba(0,0,0,0.3);';
      document.body.appendChild(banner);
    }
    let remaining = seconds;
    const update = ()=>{
      if(remaining <= 0){
        banner.textContent = 'Sess√£o expirada...';
        return;
      }
      const min = Math.floor(remaining / 60);
      const sec = remaining % 60;
      banner.textContent = `‚è±Ô∏è Sua sess√£o expira em ${min}:${sec.toString().padStart(2,'0')} ‚Äî Salve seu trabalho!`;
      remaining--;
    };
    update();
    if(countdownInterval) clearInterval(countdownInterval);
    countdownInterval = setInterval(update, 1000);
  }

  function hideCountdownBanner(){
    const banner = document.getElementById('sessionCountdownBanner');
    if(banner){ banner.remove(); }
    if(countdownInterval){ clearInterval(countdownInterval); countdownInterval = null; }
  }

  function showSessionExpiredOverlay(){
    if(document.getElementById('sessionExpiredOverlay')) return;
    hideCountdownBanner();
    const overlay = document.createElement('div');
    overlay.id = 'sessionExpiredOverlay';
    overlay.style.cssText = `position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center;`;
    overlay.innerHTML = `
      <div style="background:#1e293b; color:#e5e7eb; padding:24px; border-radius:12px; max-width:460px; text-align:center; border:1px solid rgba(148,163,184,0.25)">
        <div style="font-size:22px; font-weight:800; margin-bottom:6px">Sess√£o expirada</div>
        <div style="color:#94a3b8; margin-bottom:16px">Por seguran√ßa, sua sess√£o encerrou ap√≥s 30 minutos. Fa√ßa login novamente para continuar.</div>
        <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
          <button id="btnReLogin" style="padding:10px 14px; border-radius:10px; border: none; background:#06b6d4; color:white; font-weight:700; cursor:pointer">Fazer login novamente</button>
        </div>
      </div>`;
    document.body.appendChild(overlay);
    const btn = document.getElementById('btnReLogin');
    if(btn){ btn.addEventListener('click', ()=>{ window.location.href = '/login?expired=1'; }); }
  }

  async function doAutoLogout(){
    try{ await fetch(`${API_BASE}/auth/logout`, { method:'POST' }); }catch(_){}
    showSessionExpiredOverlay();
  }

  // Inicial
  scheduleFromServer();
  // Revalida a cada minuto para manter precis√£o sem recarregar ou trocar de p√°gina
  setInterval(scheduleFromServer, 60 * 1000);
})();
</script>

<!-- PWA Service Worker Registration -->
<script{%- if csp_nonce %} nonce="{{ csp_nonce }}"{%- endif %}>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
  navigator.serviceWorker.register('/static/sw.js?v=20251104c')
      .then((registration) => {
        console.log('‚úÖ Service Worker registrado com sucesso:', registration.scope);
        
        // Verificar atualiza√ß√µes
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('üîÑ Nova vers√£o do Service Worker encontrada');
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // Nova vers√£o dispon√≠vel
              if (confirm('üîÑ Nova vers√£o dispon√≠vel! Deseja atualizar?')) {
                newWorker.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
              }
            }
          });
        });
      })
      .catch((error) => {
        console.error('‚ùå Erro ao registrar Service Worker:', error);
      });
    
    // Recarregar quando um novo SW assume o controle
    let refreshing = false;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      if (!refreshing) {
        refreshing = true;
        window.location.reload();
      }
    });
  });
}

// Bot√£o de instala√ß√£o do PWA
let deferredPrompt;
// Disponibiliza o prompt tamb√©m no escopo global para o item de menu
window.deferredPrompt = null;
const installButton = document.createElement('button');
installButton.id = 'btnInstallPWA';
installButton.innerHTML = 'üì± Instalar App';
installButton.style.cssText = `
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 12px 20px;
  background: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%);
  color: white;
  border: none;
  border-radius: 25px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(34, 211, 238, 0.4);
  z-index: 1000;
  display: none;
  transition: transform 0.2s, box-shadow 0.2s;
`;
installButton.addEventListener('mouseenter', () => {
  installButton.style.transform = 'translateY(-2px)';
  installButton.style.boxShadow = '0 6px 20px rgba(34, 211, 238, 0.5)';
});
installButton.addEventListener('mouseleave', () => {
  installButton.style.transform = 'translateY(0)';
  installButton.style.boxShadow = '0 4px 15px rgba(34, 211, 238, 0.4)';
});

// Mostrar bot√£o quando o evento beforeinstallprompt for disparado
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  window.deferredPrompt = e;
  document.body.appendChild(installButton);
  installButton.style.display = 'block';
  
  console.log('üì± PWA pronto para instala√ß√£o');
});

// Instalar PWA
async function executarInstalacaoPWA() {
  if (!deferredPrompt) {
    // Caso o evento ainda n√£o tenha disparado, orientar o usu√°rio
    showToast ? showToast('Para instalar, use o √≠cone de instala√ß√£o do navegador ou adicione √† tela inicial.', 'info') : alert('Para instalar, use o √≠cone de instala√ß√£o do navegador ou adicione √† tela inicial.');
    return;
  }

  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;

  if (outcome === 'accepted') {
    console.log('‚úÖ PWA instalado com sucesso');
    if (typeof showToast === 'function') showToast('App instalado com sucesso! üéâ', 'success');
  } else {
    console.log('‚ùå Instala√ß√£o do PWA cancelada');
  }

  deferredPrompt = null;
  window.deferredPrompt = null;
  installButton.style.display = 'none';
}

// Bot√£o flutuante usa a mesma fun√ß√£o
installButton.addEventListener('click', executarInstalacaoPWA);

// Fun√ß√£o global para o item de menu
window.tryInstallPWA = executarInstalacaoPWA;

// Detectar quando o app est√° instalado
window.addEventListener('appinstalled', () => {
  console.log('‚úÖ PWA foi instalado');
  showToast('App instalado! Acesse pelo menu de apps.', 'success');
  installButton.style.display = 'none';
});

// Detectar se est√° rodando como PWA
if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
  console.log('üì± Rodando como PWA instalado');
  document.body.classList.add('pwa-installed');
}
</script>

