<!-- Sidebar/Admin NavegaÃ§Ã£o -->
<style>
  .admin-nav-button{
    position: fixed; top: 16px; left: 16px; z-index: 1100;
    padding: 10px 12px; border-radius: 10px;
    border: 1px solid rgba(148,163,184,0.25);
    background: rgba(15,23,42,0.55); color: var(--text);
    cursor: pointer; font-weight: 600;
  }
  #adminNavOverlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:1090; }
  #adminSidebar{
    position:fixed; top:0; left:0; bottom:0; width:260px; max-width:90vw;
    background: var(--card); color: var(--text);
    border-right: 1px solid rgba(148,163,184,0.15);
    transform: translateX(-100%); transition: transform .25s ease; z-index: 1100;
    display:flex; flex-direction:column;
  }
  #adminSidebar .side-header{ display:flex; align-items:center; justify-content:space-between; padding:16px; border-bottom:1px solid rgba(148,163,184,0.12); }
  #adminSidebar .side-header strong{ font-size: 16px; }
  #adminSidebar .side-close{ background:transparent; color:var(--text); border:none; font-size:20px; cursor:pointer; }
  #adminSidebar nav{ padding:10px 8px; overflow:auto; }
  #adminSidebar a{
    display:flex; align-items:center; gap:10px; text-decoration:none;
    color: var(--text); padding:10px 12px; border-radius:8px;
  }
  #adminSidebar a:hover{ background: rgba(148,163,184,0.12); }
  #adminSidebar a.active{
    background: rgba(34,211,238,0.15);
    border-left: 3px solid #22d3ee; /* teal admin */
  }
  #adminSidebar .section-title{ padding: 10px 12px; color: var(--muted); font-weight:700; font-size:12px; text-transform: uppercase; letter-spacing: .6px; }
  @media (min-width: 1024px){
    #adminSidebar{ transform: translateX(0) !important; }
    #adminNavOverlay{ display: none !important; }
    .admin-nav-button{ display: none !important; }
    body > .container{ margin-left: 260px; }
  }
</style>

<button id="btnOpenAdminSidebar" class="admin-nav-button">â˜° Admin</button>
<div id="adminNavOverlay" aria-hidden="true"></div>
<aside id="adminSidebar" role="navigation" aria-label="Menu do administrador">
  <div class="side-header">
    <strong>ğŸ› ï¸ AdministraÃ§Ã£o</strong>
    <button id="btnCloseAdminSidebar" class="side-close" aria-label="Fechar">âœ•</button>
  </div>
  <nav>
    <div class="section-title">Gerencial</div>
    <a href="/admin/clientes">ğŸ‘¥ Clientes</a>
    <a href="/admin/usuarios">ğŸ§‘â€ğŸ’» UsuÃ¡rios Admin</a>
    <a href="/admin/alterar-senha">ğŸ”’ Alterar Senha</a>
    <div class="section-title">Sistema</div>
    <a href="/login" data-action="sairDoSistema" style="color:#ef4444;">ğŸšª Sair</a>
  </nav>
</aside>
<script{% if csp_nonce %} nonce="{{ csp_nonce }}"{% endif %}>
  (function(){
    function toggleNav(open){
      const sb=document.getElementById('adminSidebar');
      const ov=document.getElementById('adminNavOverlay');
      if(open){ sb.style.transform='translateX(0)'; ov.style.display='block'; ov.setAttribute('aria-hidden','false'); }
      else { sb.style.transform='translateX(-100%)'; ov.style.display='none'; ov.setAttribute('aria-hidden','true'); }
    }
    const openBtn=document.getElementById('btnOpenAdminSidebar');
    const closeBtn=document.getElementById('btnCloseAdminSidebar');
    const overlay=document.getElementById('adminNavOverlay');
    if(openBtn) openBtn.addEventListener('click', ()=> toggleNav(true));
    if(closeBtn) closeBtn.addEventListener('click', ()=> toggleNav(false));
    if(overlay) overlay.addEventListener('click', ()=> toggleNav(false));
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') toggleNav(false); });

    try{
      const path = window.location.pathname.replace(/\/$/, '') || '/';
      const links = document.querySelectorAll('#adminSidebar nav a');
      links.forEach(a=>{
        const href = (a.getAttribute('href')||'').replace(/\/$/, '') || '/';
        if(href === '/'){
          if(path === '/') { a.classList.add('active'); a.setAttribute('aria-current','page'); }
        } else if (path.startsWith(href)) {
          a.classList.add('active'); a.setAttribute('aria-current','page');
        }
      });
    }catch(_e){}
  })();
</script>

<!-- SessÃ£o Admin: aviso 1 min antes e logout aos 30 min -->
<script{% if csp_nonce %} nonce="{{ csp_nonce }}"{% endif %}>
(function(){
  let warned=false, warnTimer=null, logoutTimer=null, countdownInterval=null;

  function showAdminCountdownBanner(seconds){
    let banner = document.getElementById('adminSessionCountdownBanner');
    if(!banner){
      banner = document.createElement('div');
      banner.id = 'adminSessionCountdownBanner';
      banner.style.cssText = 'position:fixed; top:0; left:0; right:0; z-index:9998; background:linear-gradient(135deg, #f59e0b, #dc2626); color:#fff; padding:10px 16px; text-align:center; font-weight:700; font-size:14px; box-shadow:0 2px 8px rgba(0,0,0,0.3);';
      document.body.appendChild(banner);
    }
    let remaining = seconds;
    const update = ()=>{
      if(remaining <= 0){
        banner.textContent = 'SessÃ£o administrativa expirada...';
        return;
      }
      const min = Math.floor(remaining / 60);
      const sec = remaining % 60;
      banner.textContent = `â±ï¸ Sua sessÃ£o de administrador expira em ${min}:${sec.toString().padStart(2,'0')} â€” Salve seu trabalho!`;
      remaining--;
    };
    update();
    if(countdownInterval) clearInterval(countdownInterval);
    countdownInterval = setInterval(update, 1000);
  }

  function hideAdminCountdownBanner(){
    const banner = document.getElementById('adminSessionCountdownBanner');
    if(banner){ banner.remove(); }
    if(countdownInterval){ clearInterval(countdownInterval); countdownInterval = null; }
  }

  function showAdminSessionExpiredOverlay(){
    if(document.getElementById('adminSessionExpiredOverlay')) return;
    hideAdminCountdownBanner();
    const overlay=document.createElement('div');
    overlay.id='adminSessionExpiredOverlay';
    overlay.style.cssText='position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center;';
    overlay.innerHTML = `
      <div style="background:#1e293b; color:#e5e7eb; padding:24px; border-radius:12px; max-width:460px; text-align:center; border:1px solid rgba(148,163,184,0.25)">
        <div style="font-size:22px; font-weight:800; margin-bottom:6px">SessÃ£o administrativa expirada</div>
        <div style="color:#94a3b8; margin-bottom:16px">Por seguranÃ§a, sua sessÃ£o encerrou apÃ³s 30 minutos. FaÃ§a login novamente.</div>
        <button id="btnReLoginAdmin" style="padding:10px 14px; border-radius:10px; border:none; background:#06b6d4; color:#fff; font-weight:700; cursor:pointer">Voltar ao login admin</button>
      </div>`;
    document.body.appendChild(overlay);
    const btn=document.getElementById('btnReLoginAdmin');
    if(btn){ btn.addEventListener('click', ()=>{ window.location.href='/admin/login?expired=1'; }); }
  }

  async function schedule(){
    try{
      const r = await fetch(`${API_BASE}/auth/session-remaining`, { credentials: 'same-origin' });
      if(!r.ok){ if(r.status===401){ showAdminSessionExpiredOverlay(); } return; }
      const j = await r.json();
      const s = Number(j?.seconds||0);
      if(warnTimer) clearTimeout(warnTimer); if(logoutTimer) clearTimeout(logoutTimer);
      if(s<=0){ try{await fetch(`${API_BASE}/auth/logout`,{method:'POST'})}catch(_){ } showAdminSessionExpiredOverlay(); return; }
      
      // Mostrar contagem regressiva se restam < 2 minutos
      if(s < 120){
        showAdminCountdownBanner(s);
      } else {
        hideAdminCountdownBanner();
      }
      
      warnTimer = setTimeout(()=>{ if(!warned){ warned=true; const m='Sua sessÃ£o de administrador expira em 1 minuto.'; if(window.Toast) Toast.warning(m); else alert(m);} }, Math.max(0,(s-60)*1000));
      logoutTimer = setTimeout(async ()=>{ try{await fetch(`${API_BASE}/auth/logout`,{method:'POST'})}catch(_){ } showAdminSessionExpiredOverlay(); }, s*1000);
    }catch(_){ }
  }
  schedule();
  setInterval(schedule, 60*1000);
})();
</script>
