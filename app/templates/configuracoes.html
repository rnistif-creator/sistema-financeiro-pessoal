<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Configura√ß√µes - Sistema Financeiro</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --primary: #22d3ee;
      --primary-strong: #06b6d4;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, sans-serif;
      line-height: 1.6;
      padding: 24px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      flex-wrap: wrap;
      gap: 16px;
    }
    .title { font-size: 28px; font-weight: 700; }
    .nav-links {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .nav-btn {
      padding: 8px 16px;
      border-radius: 12px;
      text-decoration: none;
      color: var(--primary);
      background: rgba(34,211,238,.07);
      border: 1px dashed rgba(34,211,238,.25);
      transition: all .2s ease;
    }
    .nav-btn:hover {
      background: rgba(34,211,238,.12);
      border-color: rgba(34,211,238,.35);
    }
    .section {
      background: var(--card);
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
    }
    .section-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
      font-size: 14px;
    }
    .btn-primary {
      background: linear-gradient(180deg, var(--primary), var(--primary-strong));
      color: #00212a;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(34,211,238,0.3);
    }
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    .btn-danger:hover {
      background: #dc2626;
    }
    .btn-success {
      background: var(--success);
      color: white;
    }
    .btn-success:hover {
      background: #16a34a;
    }
    .btn-outline {
      background: transparent;
      color: var(--text);
      border: 1px solid rgba(148,163,184,.35);
    }
    .btn-outline:hover {
      background: rgba(148,163,184,.1);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .table-container {
      overflow-x: auto;
      margin-top: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th {
      background: var(--bg);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid var(--primary);
    }
    td {
      padding: 12px;
      border-bottom: 1px solid rgba(148,163,184,0.1);
    }
    tr:hover {
      background: rgba(34,211,238,0.05);
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-success { background: rgba(34,197,94,0.2); color: var(--success); }
    .badge-danger { background: rgba(239,68,68,0.2); color: var(--danger); }
    .badge-warning { background: rgba(245,158,11,0.2); color: var(--warning); }
    .badge-info { background: rgba(34,211,238,0.2); color: var(--primary); }
    .alert {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .alert-success { background: rgba(34,197,94,0.1); border-left: 3px solid var(--success); }
    .alert-danger { background: rgba(239,68,68,0.1); border-left: 3px solid var(--danger); }
    .alert-warning { background: rgba(245,158,11,0.1); border-left: 3px solid var(--warning); }
    .alert-info { background: rgba(34,211,238,0.1); border-left: 3px solid var(--primary); }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: var(--bg);
      padding: 16px;
      border-radius: 8px;
      border-left: 3px solid var(--primary);
    }
    .stat-label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      margin-top: 4px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }
    .problem-item {
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 8px;
      border-left: 3px solid var(--warning);
      background: rgba(245,158,11,0.05);
    }
    .problem-item.alta {
      border-color: var(--danger);
      background: rgba(239,68,68,0.05);
    }
    .problem-item.media {
      border-color: var(--warning);
    }
  </style>
</head>
<body>
  {% include '_app_sidebar.html' %}
  <div class="container" id="main-content" tabindex="-1">
    <div class="header">
      <h1 class="title">‚öôÔ∏è Configura√ß√µes e Backup</h1>
    </div>

    <!-- Se√ß√£o: Alterar Senha -->
    <div class="section">
      <h2 class="section-title">üîê Alterar Senha</h2>
      
      <div class="alert alert-info">
        <span>‚ÑπÔ∏è</span>
        <div>
          <strong>Seguran√ßa:</strong> Use uma senha forte com pelo menos 6 caracteres.
          Combine letras mai√∫sculas, min√∫sculas, n√∫meros e s√≠mbolos.
        </div>
      </div>

      <button data-action="abrirModalSenha" class="btn btn-primary">
        üîí Alterar Senha
      </button>
    </div>

    <!-- Modal: Alterar Senha -->
    <div id="modalSenha" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
      <div style="background: var(--card); border-radius: 16px; padding: 24px; width: 90%; max-width: 480px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 1px solid rgba(148,163,184,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0; font-size: 20px; color: var(--text);">üîê Alterar Senha</h3>
          <button data-action="fecharModalSenha" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text); padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: background 0.2s;">√ó</button>
        </div>

        <form id="formAlterarSenha">
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text); font-size: 14px;">
              Senha Atual
            </label>
            <input 
              type="password" 
              id="senhaAtual" 
              required 
              autocomplete="current-password"
              style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(148,163,184,0.3); background: var(--bg); color: var(--text); font-size: 14px;"
              placeholder="Digite sua senha atual"
            />
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text); font-size: 14px;">
              Nova Senha
            </label>
            <input 
              type="password" 
              id="senhaNova" 
              required 
              minlength="6"
              autocomplete="new-password"
              style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(148,163,184,0.3); background: var(--bg); color: var(--text); font-size: 14px;"
              placeholder="M√≠nimo 6 caracteres"
              data-oninput="avaliarForcaSenha()"
            />
            <div id="forcaSenha" style="margin-top: 8px; display: none;">
              <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                <div id="barra1" style="flex: 1; height: 4px; border-radius: 2px; background: rgba(148,163,184,0.2); transition: all 0.3s;"></div>
                <div id="barra2" style="flex: 1; height: 4px; border-radius: 2px; background: rgba(148,163,184,0.2); transition: all 0.3s;"></div>
                <div id="barra3" style="flex: 1; height: 4px; border-radius: 2px; background: rgba(148,163,184,0.2); transition: all 0.3s;"></div>
                <div id="barra4" style="flex: 1; height: 4px; border-radius: 2px; background: rgba(148,163,184,0.2); transition: all 0.3s;"></div>
              </div>
              <div id="textoForca" style="font-size: 13px; font-weight: 600;"></div>
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text); font-size: 14px;">
              Confirmar Nova Senha
            </label>
            <input 
              type="password" 
              id="senhaNovaConfirmacao" 
              required 
              minlength="6"
              autocomplete="new-password"
              style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(148,163,184,0.3); background: var(--bg); color: var(--text); font-size: 14px;"
              placeholder="Digite novamente"
            />
          </div>

          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" data-action="fecharModalSenha" class="btn" style="background: rgba(148,163,184,0.1); color: var(--text);">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              ÔøΩ Salvar Nova Senha
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Se√ß√£o: Backup -->
    <div class="section">
      <h2 class="section-title">üíæ Backup e Restaura√ß√£o</h2>
      
      <div class="alert alert-info">
        <span>‚ÑπÔ∏è</span>
        <div>
          <strong>Importante:</strong> Backups s√£o criados automaticamente e mantidos por 30 dias. 
          Voc√™ pode criar backups manuais a qualquer momento ou restaurar um backup anterior.
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-primary" data-action="criarBackup">üì¶ Criar Backup Agora</button>
        <button class="btn btn-success" data-action="exportarJSON">üìÑ Exportar JSON</button>
        <button class="btn btn-outline" data-action="carregarBackups">üîÑ Atualizar Lista</button>
      </div>

      <div class="stats-grid" id="backupStats"></div>

      <div class="table-container">
        <div id="backupsLoading" class="loading">Carregando backups...</div>
        <div id="backupsContainer"></div>
      </div>
    </div>

    <!-- Se√ß√£o: Diagn√≥stico -->
    <div class="section">
      <h2 class="section-title">üîç Diagn√≥stico de Integridade</h2>
      
      <div class="actions">
        <button class="btn btn-primary" data-action="executarDiagnostico">‚ñ∂Ô∏è Executar Diagn√≥stico</button>
      </div>

      <div id="diagnosticoLoading" class="loading" style="display:none;">Executando diagn√≥stico...</div>
      <div id="diagnosticoContainer"></div>
    </div>
  </div>

  <script{%- if csp_nonce %} nonce="{{ csp_nonce }}"{%- endif %}>
    // API_BASE, brl now come from config.js

    // ========== BACKUP ==========

    async function criarBackup() {
      ConfirmDialog.show({
        title: 'Criar backup',
        message: 'Deseja criar um backup manual do banco de dados?',
        confirmText: 'Criar',
        cancelText: 'Cancelar',
        onConfirm: async () => {
          try {
            const data = await fetchWithLoading(`${API_BASE}/api/backup/criar`, { method: 'POST' }, 'Criando backup...');
            Toast.show(`Backup criado: ${data.filename} (${data.size_mb} MB)`, 'success');
            carregarBackups();
          } catch (error) {
            console.error(error);
            Toast.show(error.message || 'Erro ao criar backup', 'error');
          }
        }
      });
    }

    async function carregarBackups() {
      const loading = document.getElementById('backupsLoading');
      const container = document.getElementById('backupsContainer');
      const statsContainer = document.getElementById('backupStats');
      
      loading.style.display = 'block';
      container.innerHTML = '';
      statsContainer.innerHTML = '';

      try {
        const data = await fetchWithLoading(`${API_BASE}/api/backup/listar`, {}, 'Carregando backups...');
        const backups = data.backups || [];

        // Estat√≠sticas
        const totalSize = backups.reduce((sum, b) => sum + b.size, 0);
        const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
        
        statsContainer.innerHTML = `
          <div class="stat-card">
            <div class="stat-label">Total de Backups</div>
            <div class="stat-value">${backups.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Espa√ßo Total</div>
            <div class="stat-value">${totalSizeMB} MB</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Backup Mais Recente</div>
            <div class="stat-value">${backups.length > 0 ? backups[0].age_days + 'd' : '-'}</div>
          </div>
        `;

        if (backups.length === 0) {
          container.innerHTML = '<div class="empty-state">Nenhum backup encontrado. Crie o primeiro backup!</div>';
          return;
        }

        // Tabela de backups
        let html = `
          <table>
            <thead>
              <tr>
                <th>Arquivo</th>
                <th>Data de Cria√ß√£o</th>
                <th>Tamanho</th>
                <th>Idade</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
        `;

        backups.forEach(backup => {
          const dataFormatada = formatarDataHoraBR(backup.created_at);
          const idade = backup.age_days === 0 ? 'Hoje' : backup.age_days === 1 ? 'Ontem' : `${backup.age_days} dias`;
          
          html += `
            <tr>
              <td><strong>${backup.filename}</strong></td>
              <td>${dataFormatada}</td>
              <td>${backup.size_mb} MB</td>
              <td>${idade}</td>
              <td>
                <button class="btn btn-success" data-onclick="restaurarBackup('${backup.filename}')" style="padding:6px 12px; font-size:12px; margin-right:8px;">
                  ‚ôªÔ∏è Restaurar
                </button>
                <button class="btn btn-outline" data-onclick="baixarBackup('${backup.filename}')" style="padding:6px 12px; font-size:12px; margin-right:8px;">
                  ‚¨áÔ∏è Baixar
                </button>
                <button class="btn btn-danger" data-onclick="removerBackup('${backup.filename}')" style="padding:6px 12px; font-size:12px;">
                  üóëÔ∏è Remover
                </button>
              </td>
            </tr>
          `;
        });

        html += '</tbody></table>';
        container.innerHTML = html;

      } catch (error) {
        console.error(error);
        container.innerHTML = '<div class="empty-state">Erro ao carregar backups</div>';
        Toast.show('Erro ao carregar backups', 'error');
      } finally {
        loading.style.display = 'none';
      }
    }

    async function restaurarBackup(filename) {
      ConfirmDialog.show({
        title: 'Restaurar backup',
        message: `‚ö†Ô∏è ATEN√á√ÉO!\n\nVoc√™ est√° prestes a restaurar o banco de dados.\nO estado atual ser√° substitu√≠do pelo backup: ${filename}\n\nUm backup do estado atual ser√° criado automaticamente antes da restaura√ß√£o.\n\nDeseja continuar?`,
        confirmText: 'Restaurar',
        cancelText: 'Cancelar',
        onConfirm: async () => {
          try {
            const data = await fetchWithLoading(`${API_BASE}/api/backup/restaurar/${filename}`, { method: 'POST' }, 'Restaurando banco...');
            Toast.show(`Banco restaurado de ${data.restored_from}. Backup atual: ${data.backup_created}`, 'success');
            setTimeout(() => window.location.reload(), 1500);
          } catch (error) {
            console.error(error);
            Toast.show(error.message || 'Erro ao restaurar backup', 'error');
          }
        }
      });
    }

    async function removerBackup(filename) {
      ConfirmDialog.show({
        title: 'Remover backup',
        message: `Deseja realmente remover o backup:\n${filename}?\n\nEsta a√ß√£o n√£o pode ser desfeita!`,
        confirmText: 'Remover',
        cancelText: 'Cancelar',
        onConfirm: async () => {
          try {
            await fetchWithLoading(`${API_BASE}/api/backup/remover/${filename}`, { method: 'DELETE' }, 'Removendo backup...');
            Toast.show('Backup removido com sucesso!', 'success');
            carregarBackups();
          } catch (error) {
            console.error(error);
            Toast.show(error.message || 'Erro ao remover backup', 'error');
          }
        }
      });
    }

    function baixarBackup(filename) {
      window.open(`${API_BASE}/api/backup/download/${filename}`, '_blank');
    }

    async function exportarJSON() {
      ConfirmDialog.show({
        title: 'Exportar JSON',
        message: 'Deseja exportar todos os dados em formato JSON?\n\nO arquivo ser√° salvo no diret√≥rio de backups.',
        confirmText: 'Exportar',
        cancelText: 'Cancelar',
        onConfirm: async () => {
          try {
            const data = await fetchWithLoading(`${API_BASE}/api/exportar/json`, {}, 'Exportando dados...');
            
            // Criar e baixar arquivo JSON
            const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = data.saved_to;
            a.click();
            window.URL.revokeObjectURL(url);
            
            Toast.show(`Dados exportados: ${data.saved_to}`, 'success');
          } catch (error) {
            console.error(error);
            Toast.show(error.message || 'Erro ao exportar dados', 'error');
          }
        }
      });
    }

    // ========== DIAGN√ìSTICO ==========

    async function executarDiagnostico() {
      const loading = document.getElementById('diagnosticoLoading');
      const container = document.getElementById('diagnosticoContainer');
      
      loading.style.display = 'block';
      container.innerHTML = '';

      try {
        const data = await fetchWithLoading(`${API_BASE}/api/diagnostico`, {}, 'Executando diagn√≥stico...');
        
        let html = '';

        // Status geral
        if (data.status === 'ok') {
          html += `
            <div class="alert alert-success">
              <span>‚úÖ</span>
              <div>
                <strong>Banco de dados √≠ntegro!</strong><br>
                Nenhum problema encontrado na verifica√ß√£o.
              </div>
            </div>
          `;
        } else {
          html += `
            <div class="alert alert-warning">
              <span>‚ö†Ô∏è</span>
              <div>
                <strong>${data.total_problemas} problema(s) encontrado(s)</strong><br>
                Revise os itens abaixo e tome as a√ß√µes necess√°rias.
              </div>
            </div>
          `;
        }

        // Estat√≠sticas
        if (data.estatisticas) {
          const stats = data.estatisticas;
          html += `
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-label">Lan√ßamentos</div>
                <div class="stat-value">${stats.total_lancamentos}</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Parcelas Totais</div>
                <div class="stat-value">${stats.total_parcelas}</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Pagas</div>
                <div class="stat-value" style="color:var(--success)">${stats.parcelas_pagas}</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Pendentes</div>
                <div class="stat-value" style="color:var(--warning)">${stats.parcelas_pendentes}</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Tipos Cadastrados</div>
                <div class="stat-value">${stats.total_tipos}</div>
              </div>
            </div>
          `;
        }

        // Problemas encontrados
        if (data.problemas && data.problemas.length > 0) {
          html += '<h3 style="margin-top:24px; margin-bottom:12px; font-size:18px;">Problemas Encontrados</h3>';
          
          data.problemas.forEach(problema => {
            html += `
              <div class="problem-item ${problema.severidade}">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <div>
                    <strong>${problema.descricao}</strong>
                    <div style="margin-top:4px;">
                      <span class="badge badge-${problema.severidade === 'alta' ? 'danger' : problema.severidade === 'media' ? 'warning' : 'info'}">
                        ${problema.severidade.toUpperCase()}
                      </span>
                      <span style="margin-left:8px; color:var(--muted); font-size:13px;">
                        Tipo: ${problema.tipo}
                      </span>
                    </div>
                  </div>
                  <div style="font-size:24px; font-weight:700; color:${problema.severidade === 'alta' ? 'var(--danger)' : 'var(--warning)'}">
                    ${problema.quantidade}
                  </div>
                </div>
              </div>
            `;
          });
        }

        // Data de verifica√ß√£o
        html += `
          <div style="margin-top:20px; text-align:center; color:var(--muted); font-size:13px;">
            Diagn√≥stico executado em: ${formatarDataHoraBR(data.data_verificacao)}
          </div>
        `;

        container.innerHTML = html;

      } catch (error) {
        console.error(error);
        container.innerHTML = '<div class="empty-state">Erro ao executar diagn√≥stico</div>';
        Toast.show('Erro ao executar diagn√≥stico', 'error');
      } finally {
        loading.style.display = 'none';
      }
    }

    // Carregar dados ao iniciar
    carregarBackups();

    // ============================================
    // ALTERA√á√ÉO DE SENHA
    // ============================================

    function abrirModalSenha() {
      document.getElementById('modalSenha').style.display = 'flex';
      // Limpar campos ao abrir
      document.getElementById('senhaAtual').value = '';
      document.getElementById('senhaNova').value = '';
      document.getElementById('senhaNovaConfirmacao').value = '';
      document.getElementById('forcaSenha').style.display = 'none';
      // Focar no primeiro campo
      setTimeout(() => {
        document.getElementById('senhaAtual').focus();
      }, 100);
    }

    function fecharModalSenha() {
      document.getElementById('modalSenha').style.display = 'none';
      // Limpar campos ao fechar
      document.getElementById('senhaAtual').value = '';
      document.getElementById('senhaNova').value = '';
      document.getElementById('senhaNovaConfirmacao').value = '';
      document.getElementById('forcaSenha').style.display = 'none';
    }

    // Fechar modal ao clicar fora do card
    document.getElementById('modalSenha').addEventListener('click', (e) => {
      if (e.target.id === 'modalSenha') {
        fecharModalSenha();
      }
    });

    // Fechar modal com ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && document.getElementById('modalSenha').style.display === 'flex') {
        fecharModalSenha();
      }
    });

    function avaliarForcaSenha() {
      const senha = document.getElementById('senhaNova').value;
      const forcaDiv = document.getElementById('forcaSenha');
      const textoForca = document.getElementById('textoForca');
      const barras = ['barra1', 'barra2', 'barra3', 'barra4'];
      
      if (!senha) {
        forcaDiv.style.display = 'none';
        return;
      }
      
      forcaDiv.style.display = 'block';
      
      // Calcular for√ßa da senha
      let forca = 0;
      
      // Crit√©rios
      if (senha.length >= 8) forca++;
      if (senha.length >= 12) forca++;
      if (/[a-z]/.test(senha) && /[A-Z]/.test(senha)) forca++; // Mai√∫sculas e min√∫sculas
      if (/[0-9]/.test(senha)) forca++; // N√∫meros
      if (/[^a-zA-Z0-9]/.test(senha)) forca++; // S√≠mbolos
      
      // Normalizar (0-4)
      forca = Math.min(4, Math.max(1, Math.ceil(forca / 1.5)));
      
      // Resetar barras
      barras.forEach(id => {
        document.getElementById(id).style.background = 'rgba(148,163,184,0.2)';
      });
      
      // Colorir barras e definir texto
      let cor, texto;
      if (forca === 1) {
        cor = '#ef4444'; // Vermelho
        texto = 'Fraca';
        document.getElementById('barra1').style.background = cor;
      } else if (forca === 2) {
        cor = '#f59e0b'; // Laranja
        texto = 'M√©dia';
        document.getElementById('barra1').style.background = cor;
        document.getElementById('barra2').style.background = cor;
      } else if (forca === 3) {
        cor = '#22d3ee'; // Ciano
        texto = 'Boa';
        for (let i = 0; i < 3; i++) {
          document.getElementById(barras[i]).style.background = cor;
        }
      } else {
        cor = '#22c55e'; // Verde
        texto = 'Forte';
        barras.forEach(id => {
          document.getElementById(id).style.background = cor;
        });
      }
      
      textoForca.textContent = `Senha ${texto}`;
      textoForca.style.color = cor;
    }

    document.getElementById('formAlterarSenha').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const senhaAtual = document.getElementById('senhaAtual').value;
      const senhaNova = document.getElementById('senhaNova').value;
      const senhaNovaConfirmacao = document.getElementById('senhaNovaConfirmacao').value;
      
      // Validar que as senhas novas conferem
      if (senhaNova !== senhaNovaConfirmacao) {
        Toast.show('As senhas novas n√£o conferem', 'error');
        return;
      }
      
      // Validar tamanho m√≠nimo
      if (senhaNova.length < 6) {
        Toast.show('A nova senha deve ter no m√≠nimo 6 caracteres', 'error');
        return;
      }
      
      try {
        LoadingOverlay.show('Alterando senha...');
        
        const response = await fetch(`${API_BASE}/auth/change-password`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            senha_atual: senhaAtual,
            senha_nova: senhaNova,
            senha_nova_confirmacao: senhaNovaConfirmacao
          })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Erro ao alterar senha');
        }
        
        Toast.show('‚úÖ Senha alterada com sucesso!', 'success');
        
        // Limpar formul√°rio
        document.getElementById('formAlterarSenha').reset();
        document.getElementById('forcaSenha').style.display = 'none';
        
        // Fazer logout autom√°tico ap√≥s 2 segundos
        setTimeout(async () => {
          try {
            await fetch(`${API_BASE}/auth/logout`, { 
              method: 'POST',
              credentials: 'include'
            });
            
            // Redirecionar para login com mensagem
            window.location.href = '/login?msg=senha_alterada';
          } catch (e) {
            // Mesmo se o logout falhar, redireciona
            window.location.href = '/login?msg=senha_alterada';
          }
        }, 2000);
        
      } catch (error) {
        console.error(error);
        Toast.show(error.message, 'error');
      } finally {
        LoadingOverlay.hide();
      }
    });

    // ============================================
    // ATALHOS DE TECLADO
    // ============================================

    // Atalhos de teclado
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && !e.shiftKey && !e.altKey) {
        switch (e.key.toLowerCase()) {
          case 'b':
            e.preventDefault();
            criarBackup();
            break;
          case 'e':
            e.preventDefault();
            exportarJSON();
            break;
          case 'r':
            e.preventDefault();
            carregarBackups();
            break;
          case 'd':
            e.preventDefault();
            executarDiagnostico();
            break;
        }
      }
    });
  </script>
</body>
</html>
