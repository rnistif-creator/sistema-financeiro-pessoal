<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Lan√ßamentos Financeiros - MVP</title>
    <style>
      /* Estilos espec√≠ficos desta p√°gina (base est√° no components.css) */
      .navbar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }
    </style>
  </head>
  <body>
    {% include '_app_sidebar.html' %}
    <div class="container" id="main-content">
      <div class="navbar">
        <div>
          <h1 class="title">üíº Lan√ßamentos Financeiros</h1>
          <p class="subtitle">Preencha os campos abaixo e clique em <strong>Lan√ßar</strong>.</p>
        </div>
        <div style="display:flex; gap:12px">
          <button type="button" id="btnExportarExcel" style="padding:10px 20px; background:linear-gradient(135deg, #10b981, #059669); color:white; border:none; border-radius:10px; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:8px; transition:all .2s; box-shadow:0 4px 12px rgba(16,185,129,0.3);">
            üìä Exportar Excel
          </button>
        </div>
      </div>

      <div class="card">
        <form id="formLancamento" class="grid" autocomplete="off" aria-label="Formul√°rio de lan√ßamento financeiro">
          <div class="input-row">
            <div>
              <label for="dataLancamento">Data de lan√ßamento</label>
              <input type="date" id="dataLancamento" name="dataLancamento" required>
            </div>

            <div>
              <label for="dataPrimeiroVencimento">Data do primeiro vencimento</label>
              <input type="date" id="dataPrimeiroVencimento" name="dataPrimeiroVencimento" required>
            </div>
          </div>

          <div class="input-row">
            <div>
              <label for="tipo">Natureza</label>
              <select id="tipo" name="tipo" required data-onchange="atualizarTiposLancamento()">
                <option value="" disabled selected>Selecione</option>
                <option value="despesa">Despesa</option>
                <option value="receita">Receita</option>
              </select>
            </div>

            <div>
              <label for="tipoLancamento">Tipo de Lan√ßamento</label>
              <select id="tipoLancamento" name="tipoLancamento" required disabled>
                <option value="" disabled selected>Selecione primeiro a natureza</option>
              </select>
            </div>
            <div>
              <label for="subtipoLancamento">Subtipo</label>
              <select id="subtipoLancamento" name="subtipoLancamento" disabled>
                <option value="" disabled selected>Selecione primeiro o tipo</option>
              </select>
            </div>
          </div>

          <div>
            <label for="fornecedor">Fornecedor ou Despesa</label>
            <input type="text" id="fornecedor" name="fornecedor" placeholder="Ex.: ACME Materiais, Energia, IPTU..." required>
            <div class="input-description">Nome da empresa, pessoa ou descri√ß√£o do lan√ßamento</div>
          </div>

          <div class="input-row">
            <div>
              <label for="valorTotal">Valor total</label>
              <input type="number" step="0.01" min="0" inputmode="decimal" id="valorTotal" name="valorTotal" placeholder="0,00" required>
              <div class="input-description">Digite o valor usando v√≠rgula (ex.: 1234,56)</div>
            </div>

            <div>
              <label for="numeroParcelas">N√∫mero de parcelas</label>
              <div class="inline">
                <input type="number" min="1" step="1" id="numeroParcelas" name="numeroParcelas" placeholder="1" required>
                <div class="readonly-chip" aria-live="polite">
                  <span class="sr-only">Valor m√©dio das parcelas:</span>
                  <span id="valorMedio">R$ 0,00</span>
                </div>
              </div>
              <div class="input-description">Valor m√©dio = Valor total √∑ N¬∫ de parcelas</div>
            </div>
          </div>

          <div>
            <label for="observacao">Observa√ß√µes</label>
            <textarea id="observacao" name="observacao" placeholder="Digite aqui qualquer observa√ß√£o adicional sobre o lan√ßamento..."></textarea>
          </div>

          <div class="col-12 buttons">
            <button type="button" id="btnCancelar" class="btn btn-outline" style="display:none">Cancelar Edi√ß√£o</button>
            <button type="button" id="btnZerar" class="btn btn-outline">Zerar</button>
            <a href="/recorrentes" class="btn btn-outline" style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center;">üîÅ Recorrentes</a>
            <button type="submit" class="btn btn-primary">Lan√ßar</button>
          </div>
        </form>

        <div id="toast" class="toast" role="status" aria-live="polite"></div>
      </div>
    </div>

    <script{%- if csp_nonce %} nonce="{{ csp_nonce }}"{%- endif %}>
      const $ = (sel) => document.querySelector(sel);
      const form = $("#formLancamento");
      const valorTotalEl = $("#valorTotal");
      const parcelasEl = $("#numeroParcelas");
      const valorMedioEl = $("#valorMedio");
      const toast = $("#toast");
      const dataLancEl = $("#dataLancamento");
      const dataPrimVencEl = $("#dataPrimeiroVencimento");
      const btnZerar = $("#btnZerar");
      const btnCancelar = $("#btnCancelar");
      const btnSubmit = form.querySelector('button[type="submit"]');
  const tipoLancSelect = document.getElementById('tipoLancamento');
  const subtipoLancSelect = document.getElementById('subtipoLancamento');

      // Define datas padr√£o = hoje (fuso do navegador)
      function todayISO(){
        const d = new Date();
        d.setMinutes(d.getMinutes() - d.getTimezoneOffset()); // normaliza p/ input[type=date]
        return d.toISOString().split('T')[0];
      }
      dataLancEl.value = todayISO();
      dataPrimVencEl.value = todayISO();

      // Formatador BRL
      const brl = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

      // Formatador de data (AAAA-MM-DD -> DD/MM/AAAA)
      // Fun√ß√µes utilit√°rias
      function parseNumber(v){
        if (typeof v === 'number') return v;
        if (!v) return 0;
        // Aceita tanto v√≠rgula quanto ponto como separador decimal
        const n = Number(String(v).replace(',', '.'));
        return isNaN(n) ? 0 : n;
      }

      function formatNumber(value) {
        // Formata n√∫mero para usar v√≠rgula como separador decimal
        return String(value).replace('.', ',');
      }

      function updateValorMedio(){
        const total = parseNumber(valorTotalEl.value);
        const n = parseInt(parcelasEl.value, 10);
        const medio = (!n || n <= 0) ? 0 : total / n;
        valorMedioEl.textContent = brl.format(medio || 0).replace('.', ',');
      }

      valorTotalEl.addEventListener('input', updateValorMedio);
      parcelasEl.addEventListener('input', updateValorMedio);

      btnZerar.addEventListener('click', () => {
        form.reset();
        dataLancEl.value = todayISO();
        dataPrimVencEl.value = todayISO();
        valorMedioEl.textContent = brl.format(0);
        atualizarTiposLancamento();
        resetSubtipoSelect();
        showToast("Formul√°rio zerado.", "info");
      });

      btnCancelar.addEventListener('click', () => {
        editandoId = null;
        btnSubmit.textContent = 'Lan√ßar';
        btnCancelar.style.display = 'none';
        form.reset();
        dataLancEl.value = todayISO();
        dataPrimVencEl.value = todayISO();
        valorMedioEl.textContent = brl.format(0);
        atualizarTiposLancamento();
        resetSubtipoSelect();
        showToast("Edi√ß√£o cancelada.", "info");
      });

      // Usar o novo componente Toast
      function showToast(msg, type="success"){
        Toast.show(msg, type);
      }
    
      // Cache dos tipos de lan√ßamento e subtipos
      let tiposLancamento = [];
      const subtiposCache = {}; // { [tipoLancamentoId]: Subtipo[] }

      // API_BASE agora vem de config.js global

      // Carregar tipos de lan√ßamento
      async function carregarTiposLancamento() {
        try {
          const res = await fetch(`${API_BASE}/api/tipos`);
          if (!res.ok) throw new Error('Falha ao carregar tipos');
          tiposLancamento = await res.json();
          atualizarTiposLancamento();
        } catch (err) {
          showToast('Erro ao carregar tipos de lan√ßamento: ' + err.message, 'error');
        }
      }

      function atualizarTiposLancamento() {
        const natureza = $("#tipo").value;
        const select = $("#tipoLancamento");
        // ao trocar natureza, resetar subtipo
        resetSubtipoSelect();
        
        if (!natureza) {
          select.innerHTML = '<option value="" disabled selected>Selecione primeiro a natureza</option>';
          select.disabled = true;
          return;
        }

        const tipos = tiposLancamento.filter(t => t.natureza === natureza);
        select.innerHTML = `
          <option value="" disabled selected>Selecione o tipo</option>
          ${tipos.map(t => `<option value="${t.id}">${t.nome}</option>`).join('')}
        `;
        select.disabled = false;
      }

      function resetSubtipoSelect(){
        subtipoLancSelect.innerHTML = '<option value="" disabled selected>Selecione primeiro o tipo</option>';
        subtipoLancSelect.disabled = true;
      }

      async function carregarSubtipos(tipoLancamentoId){
        if (!tipoLancamentoId){ resetSubtipoSelect(); return; }
        if (subtiposCache[tipoLancamentoId]){
          preencherSubtipos(subtiposCache[tipoLancamentoId]);
          return;
        }
        try{
          const res = await fetch(`${API_BASE}/api/tipos/${tipoLancamentoId}/subtipos`);
          if (!res.ok) throw new Error('Falha ao carregar subtipos');
          const data = await res.json();
          const ativos = Array.isArray(data) ? data.filter(s => s.ativo) : [];
          subtiposCache[tipoLancamentoId] = ativos;
          preencherSubtipos(ativos);
        }catch(err){
          console.error(err);
          resetSubtipoSelect();
          Toast.error('Erro ao carregar subtipos');
        }
      }

      function preencherSubtipos(lista){
        if (!lista || lista.length === 0){
          subtipoLancSelect.innerHTML = '<option value="" disabled selected>Nenhum subtipo dispon√≠vel</option>';
          subtipoLancSelect.disabled = true;
          return;
        }
        subtipoLancSelect.innerHTML = `
          <option value="">(Opcional) Selecione um subtipo</option>
          ${lista.map(s => `<option value="${s.id}">${s.nome}</option>`).join('')}
        `;
        subtipoLancSelect.disabled = false;
      }

      // Quando mudar o tipo, carregar subtipos
      tipoLancSelect.addEventListener('change', (e)=>{
        const id = e.target.value ? parseInt(e.target.value, 10) : null;
        carregarSubtipos(id);
      });

      // Carregar subtipos de todos os tipos ao iniciar (para exibi√ß√£o na tabela)
      async function precarregarSubtipos() {
        for (const tipo of tiposLancamento) {
          if (!subtiposCache[tipo.id]) {
            try {
              const res = await fetch(`${API_BASE}/api/tipos/${tipo.id}/subtipos`);
              if (res.ok) {
                const data = await res.json();
                subtiposCache[tipo.id] = Array.isArray(data) ? data : [];
              }
            } catch (err) {
              console.warn(`Erro ao carregar subtipos do tipo ${tipo.id}:`, err);
            }
          }
        }
      }

      // Carregar tipos e subtipos ao iniciar
      carregarTiposLancamento().then(() => {
        precarregarSubtipos();
      });

      // ========== EXPORTA√á√ÉO EXCEL ==========
      async function exportarLancamentosExcel() {
        try {
          LoadingOverlay.show('Gerando Excel...');
          
          // Construir URL com par√¢metros (sem filtros por enquanto, exporta tudo)
          const url = `${API_BASE}/api/relatorios/lancamentos-excel`;
          
          const res = await fetch(url);
          if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || 'Erro ao gerar Excel');
          }
          
          const blob = await res.blob();
          const downloadUrl = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = downloadUrl;
          a.download = `lancamentos_${new Date().getTime()}.xlsx`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(downloadUrl);
          document.body.removeChild(a);
          
          LoadingOverlay.hide();
          Toast.success('‚úÖ Excel gerado com sucesso!');
        } catch (error) {
          console.error(error);
          LoadingOverlay.hide();
          Toast.error('‚ùå ' + error.message);
        }
      }

      async function saveLancamento(payload){
        // Usa helper com overlay e timeout para evitar travar silenciosamente
        return await fetchWithLoading(`${API_BASE}/api/lancamentos`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          timeout: 20000
        }, 'Salvando lan√ßamento...');
      }

      async function listLancamentos(filtros = {}){
        const params = new URLSearchParams();
        if (filtros.tipo) params.append('tipo', filtros.tipo);
        if (filtros.tipo_lancamento_id) params.append('tipo_lancamento_id', filtros.tipo_lancamento_id);
        if (filtros.subtipo_lancamento_id) params.append('subtipo_lancamento_id', filtros.subtipo_lancamento_id);
        if (filtros.fornecedor) params.append('fornecedor', filtros.fornecedor);
        if (filtros.data_inicio) params.append('data_inicio', filtros.data_inicio);
        if (filtros.data_fim) params.append('data_fim', filtros.data_fim);
        
        const url = `${API_BASE}/api/lancamentos${params.toString() ? '?' + params.toString() : ''}`;
        const res = await fetch(url, {
          credentials: 'include'
        });
        if(!res.ok) return [];
        return res.json();
      }

      function toggleFiltros() {
        const filtros = $("#filtros");
        filtros.style.display = filtros.style.display === 'none' ? 'block' : 'none';
      }

      async function aplicarFiltros() {
        const filtros = {
          tipo: $("#filtroNatureza").value,
          tipo_lancamento_id: $("#filtroTipoLancamento").value,
          subtipo_lancamento_id: $("#filtroSubtipo").value,
          fornecedor: $("#filtroFornecedor").value.trim(),
          data_inicio: $("#filtroDataInicio").value,
          data_fim: $("#filtroDataFim").value
        };
        
        const data = await listLancamentos(filtros).catch(() => []);
        document.getElementById('lista').innerHTML = tabela(data);
        
        showToast('Filtros aplicados!', 'info');
      }

      function limparFiltros() {
        $("#filtroNatureza").value = '';
        $("#filtroTipoLancamento").value = '';
        $("#filtroTipoLancamento").disabled = true;
        $("#filtroSubtipo").value = '';
        $("#filtroSubtipo").disabled = true;
        $("#filtroFornecedor").value = '';
        $("#filtroDataInicio").value = '';
        $("#filtroDataFim").value = '';
        refreshList();
        showToast('Filtros limpos!', 'info');
      }

      function atualizarFiltroTipos() {
        const natureza = $("#filtroNatureza").value;
        const select = $("#filtroTipoLancamento");
        const subtipoSelect = $("#filtroSubtipo");
        
        // Resetar subtipo
        subtipoSelect.innerHTML = '<option value="">Todos</option>';
        subtipoSelect.disabled = true;
        
        if (!natureza) {
          select.innerHTML = '<option value="">Todos</option>';
          select.disabled = true;
          return;
        }

        const tipos = tiposLancamento.filter(t => t.natureza === natureza);
        select.innerHTML = `
          <option value="">Todos</option>
          ${tipos.map(t => `<option value="${t.id}">${t.nome}</option>`).join('')}
        `;
        select.disabled = false;
      }

      async function atualizarFiltroSubtipos() {
        const tipoId = $("#filtroTipoLancamento").value;
        const select = $("#filtroSubtipo");
        
        if (!tipoId) {
          select.innerHTML = '<option value="">Todos</option>';
          select.disabled = true;
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/api/tipos/${tipoId}/subtipos`);
          if (!res.ok) throw new Error('Falha ao carregar subtipos');
          const data = await res.json();
          const ativos = Array.isArray(data) ? data.filter(s => s.ativo) : [];
          
          if (ativos.length === 0) {
            select.innerHTML = '<option value="">Nenhum subtipo</option>';
            select.disabled = true;
            return;
          }
          
          select.innerHTML = `
            <option value="">Todos</option>
            ${ativos.map(s => `<option value="${s.id}">${s.nome}</option>`).join('')}
          `;
          select.disabled = false;
        } catch (err) {
          console.error(err);
          select.innerHTML = '<option value="">Erro ao carregar</option>';
          select.disabled = true;
        }
      }

      // render tabela simples
      const listContainer = document.createElement('div');
      listContainer.className = 'card';
      listContainer.style.marginTop = '18px';
      listContainer.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
          <h3 style="margin:0">√öltimos lan√ßamentos</h3>
          <button data-action="toggleFiltros" class="btn-link" style="padding:8px 16px">üîç Filtros</button>
        </div>
        <div id="filtros" style="display:none; padding:16px; background:rgba(15,23,42,0.5); border-radius:12px; margin-bottom:16px">
          <div class="input-row" style="gap:12px; margin-bottom:12px">
            <div>
              <label for="filtroNatureza">Natureza</label>
              <select id="filtroNatureza" data-onchange="atualizarFiltroTipos()">
                <option value="">Todas</option>
                <option value="receita">Receita</option>
                <option value="despesa">Despesa</option>
              </select>
            </div>
            <div>
              <label for="filtroTipoLancamento">Tipo de Lan√ßamento</label>
              <select id="filtroTipoLancamento" disabled data-onchange="atualizarFiltroSubtipos()">
                <option value="">Todos</option>
              </select>
            </div>
            <div>
              <label for="filtroSubtipo">Subtipo</label>
              <select id="filtroSubtipo" disabled>
                <option value="">Todos</option>
              </select>
            </div>
          </div>
          <div class="input-row" style="gap:12px">
            <div>
              <label for="filtroFornecedor">Fornecedor</label>
              <input type="text" id="filtroFornecedor" placeholder="Digite para buscar...">
            </div>
            <div>
              <label for="filtroDataInicio">Data In√≠cio</label>
              <input type="date" id="filtroDataInicio">
            </div>
            <div>
              <label for="filtroDataFim">Data Fim</label>
              <input type="date" id="filtroDataFim">
            </div>
          </div>
          <div class="buttons" style="margin-top:12px">
            <button data-action="limparFiltros" class="btn btn-outline">Limpar</button>
            <button data-action="aplicarFiltros" class="btn btn-primary">Aplicar</button>
          </div>
        </div>
        <div id="lista"></div>
      `;
      document.querySelector('.container').appendChild(listContainer);

      function obterNomeTipo(tipoId) {
        if (!tipoId) return '-';
        const tipo = tiposLancamento.find(t => t.id === tipoId);
        return tipo ? tipo.nome : `ID ${tipoId}`;
      }

      function obterNomeSubtipo(tipoId, subtipoId) {
        if (!subtipoId) return '-';
        if (!tipoId || !subtiposCache[tipoId]) return `ID ${subtipoId}`;
        const subtipo = subtiposCache[tipoId].find(s => s.id === subtipoId);
        return subtipo ? subtipo.nome : `ID ${subtipoId}`;
      }

      function tabela(l){
        if(!l || l.length === 0) return '<p class="hint">Nenhum lan√ßamento encontrado.</p>';
        const rows = l.map(x => {
          const nomeTipo = obterNomeTipo(x.tipo_lancamento_id);
          const nomeSubtipo = obterNomeSubtipo(x.tipo_lancamento_id, x.subtipo_lancamento_id);
          
          return `
          <tr style="border-bottom: 1px solid rgba(148,163,184,0.1)" id="lanc-${x.id}">
            <td style="padding: 12px 8px">${formatarDataBR(x.data_primeiro_vencimento)}</td>
            <td style="padding: 12px 8px">${x.id}</td>
            <td style="padding: 12px 8px">
              <span style="display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600; 
                background: ${x.tipo === 'receita' ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)'};
                color: ${x.tipo === 'receita' ? '#22c55e' : '#ef4444'}">
                ${x.tipo === 'receita' ? 'üìà' : 'üìâ'} ${x.tipo}
              </span>
            </td>
            <td style="padding: 12px 8px; font-size:13px; color:var(--muted)">${nomeTipo}</td>
            <td style="padding: 12px 8px; font-size:12px; color:var(--text)">${nomeSubtipo}</td>
            <td style="padding: 12px 8px">${x.fornecedor}</td>
            <td style="padding: 12px 8px; font-weight:600">${brl.format(x.valor_total)}</td>
            <td style="padding: 12px 8px; text-align:center">
              <button data-action="toggleParcelas" data-args='[${x.id}]' style="padding:4px 10px; border:none; border-radius:6px; background:rgba(168,85,247,0.15); color:#a855f7; cursor:pointer; font-size:12px; font-weight:600" title="Ver Parcelas">
                ${x.numero_parcelas}x üìã
              </button>
            </td>
            <td style="padding: 12px 8px">${brl.format(x.valor_medio_parcelas)}</td>
            <td style="padding: 12px 8px">${formatarDataBR(x.data_lancamento)}</td>
            <td style="padding: 12px 8px; text-align:right">
              <button data-action="editarLancamento" data-args='[${x.id}]' style="padding:6px 12px; border:none; border-radius:6px; background:rgba(34,211,238,0.15); color:#22d3ee; cursor:pointer; margin-right:6px" title="Editar">
                ‚úèÔ∏è
              </button>
              <button data-action="excluirLancamento" data-args='[${x.id}]' style="padding:6px 12px; border:none; border-radius:6px; background:rgba(239,68,68,0.15); color:#ef4444; cursor:pointer" title="Excluir">
                üóëÔ∏è
              </button>
            </td>
          </tr>
          <tr id="parcelas-${x.id}" style="display:none">
            <td colspan="11" style="padding:0; background:rgba(15,23,42,0.5)">
              <div style="padding:16px; border-left: 3px solid #a855f7">
                <div id="parcelas-content-${x.id}">Carregando parcelas...</div>
              </div>
            </td>
          </tr>`;
        }).join('');
        return `
          <div style="overflow:auto">
          <table style="width:100%; border-collapse:collapse; font-size:14px">
            <thead>
              <tr style="text-align:left; color:var(--muted); border-bottom: 2px solid rgba(148,163,184,0.2)">
                <th style="padding: 12px 8px">Data Venc.</th>
                <th style="padding: 12px 8px">ID</th>
                <th style="padding: 12px 8px">Natureza</th>
                <th style="padding: 12px 8px">Tipo</th>
                <th style="padding: 12px 8px">Subtipo</th>
                <th style="padding: 12px 8px">Fornecedor</th>
                <th style="padding: 12px 8px">Valor Total</th>
                <th style="padding: 12px 8px; text-align:center">Parcelas</th>
                <th style="padding: 12px 8px">M√©dia</th>
                <th style="padding: 12px 8px">Data Lan√ß.</th>
                <th style="padding: 12px 8px; text-align:right">A√ß√µes</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
          </div>`;
      }

      let editandoId = null;

      async function refreshList(){
        const data = await listLancamentos().catch(()=>[]);
        document.getElementById('lista').innerHTML = tabela(data);
      }

      async function editarLancamento(id) {
        try {
          const res = await fetch(`${API_BASE}/api/lancamentos/${id}`);
          if (!res.ok) throw new Error('Lan√ßamento n√£o encontrado');
          
          const lanc = await res.json();
          
          // Preencher o formul√°rio
          dataLancEl.value = lanc.data_lancamento;
          $("#tipo").value = lanc.tipo;
          await carregarTiposLancamento();
          atualizarTiposLancamento();
          $("#tipoLancamento").value = lanc.tipo_lancamento_id || '';
          if (lanc.tipo_lancamento_id) {
            await carregarSubtipos(lanc.tipo_lancamento_id);
            $("#subtipoLancamento").value = lanc.subtipo_lancamento_id || '';
          } else {
            resetSubtipoSelect();
          }
          $("#fornecedor").value = lanc.fornecedor;
          valorTotalEl.value = lanc.valor_total;
          dataPrimVencEl.value = lanc.data_primeiro_vencimento;
          parcelasEl.value = lanc.numero_parcelas;
          $("#observacao").value = lanc.observacao || '';
          
          updateValorMedio();
          
          // Marcar como editando
          editandoId = id;
          
          // Alterar interface para modo edi√ß√£o
          btnSubmit.textContent = 'Atualizar';
          btnCancelar.style.display = 'inline-block';
          
          // Scroll para o formul√°rio
          form.scrollIntoView({ behavior: 'smooth', block: 'start' });
          
          showToast(`Editando lan√ßamento #${id}`, 'info');
        } catch (err) {
          showToast('Erro ao carregar lan√ßamento: ' + err.message, 'error');
        }
      }

      async function excluirLancamento(id) {
        ConfirmDialog.show({
          title: 'Excluir lan√ßamento',
          message: `Tem certeza que deseja excluir o lan√ßamento #${id}?\n\nEsta a√ß√£o n√£o pode ser desfeita.`,
          confirmText: 'Excluir',
          cancelText: 'Cancelar',
          variant: 'danger',
          onConfirm: async () => {
            try {
              await fetchWithLoading(`${API_BASE}/api/lancamentos/${id}`, { method: 'DELETE' }, 'Excluindo...');
              Toast.success('Lan√ßamento exclu√≠do com sucesso!');
              await refreshList();
            } catch (err) {
              Toast.error('Erro: ' + (err.message || 'Falha ao excluir'));
            }
          }
        });
      }

      // Hook submit para salvar no banco
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Garantir que tipo_lancamento_id seja um n√∫mero inteiro ou null
        const tipoLancIdRaw = document.getElementById('tipoLancamento').value;
        const tipoLancId = tipoLancIdRaw ? parseInt(tipoLancIdRaw, 10) : null;
        const subtipoLancIdRaw = document.getElementById('subtipoLancamento').value;
        const subtipoLancId = subtipoLancIdRaw ? parseInt(subtipoLancIdRaw, 10) : null;
        
        // Garantir que os valores num√©ricos sejam n√∫meros
        const valorTotal = parseNumber(valorTotalEl.value);
        const numParcelas = parseInt(parcelasEl.value, 10) || 1;
        const valorMedioParcelas = numParcelas > 0 ? Math.round((valorTotal / numParcelas) * 100) / 100 : 0;
        
        const payload = {
          data_lancamento: dataLancEl.value,
          tipo: document.getElementById('tipo').value,
          tipo_lancamento_id: tipoLancId,
          subtipo_lancamento_id: subtipoLancId,
          fornecedor: document.getElementById('fornecedor').value.trim(),
          valor_total: valorTotal,
          data_primeiro_vencimento: dataPrimVencEl.value,
          numero_parcelas: numParcelas,
          valor_medio_parcelas: valorMedioParcelas,
          observacao: document.getElementById('observacao').value.trim()
        };
        
        console.log('Payload sendo enviado:', payload);
        
        try{
          let saved;
          let salvou = false;
          if (editandoId) {
            // Atualizar
            saved = await fetchWithLoading(`${API_BASE}/api/lancamentos/${editandoId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
              timeout: 20000
            }, 'Atualizando lan√ßamento...');
            salvou = true;
            editandoId = null;
            btnSubmit.textContent = 'Lan√ßar';
            btnCancelar.style.display = 'none';
          } else {
            // Criar novo
            saved = await saveLancamento(payload);
            salvou = true;
          }
          
          try {
            await refreshList();
          } catch (e) {
            console.warn('Falha ao atualizar lista ap√≥s salvar:', e);
          }

          try {
            form.reset();
            dataLancEl.value = todayISO();
            dataPrimVencEl.value = todayISO();
            valorMedioEl.textContent = brl.format(0);
            atualizarTiposLancamento();
            resetSubtipoSelect();
          } catch (e) {
            console.warn('Falha ao resetar formul√°rio:', e);
          }

          // S√≥ mostrar sucesso ao final de tudo para evitar "salvou mas deu erro"
          Toast.success(editandoId ? 'Lan√ßamento atualizado com sucesso!' : 'Lan√ßamento salvo com sucesso!');
        }catch(err){
          console.error('Erro ao salvar:', err);
          // Se j√° salvou mas algum passo subsequente falhou, avisar como warning
          if (typeof salvou !== 'undefined' && salvou) {
            Toast.warning('Lan√ßamento salvo, mas ocorreu um problema ao finalizar: ' + (err.message || 'verifique a conex√£o'));
          } else {
            showToast('Erro: ' + err.message, 'error');
          }
        }
      });

      // === FUN√á√ïES DE PARCELAS ===
      
      async function toggleParcelas(lancamentoId) {
        const row = document.getElementById(`parcelas-${lancamentoId}`);
        const isVisible = row.style.display !== 'none';
        
        if (isVisible) {
          row.style.display = 'none';
        } else {
          row.style.display = 'table-row';
          await carregarParcelas(lancamentoId);
        }
      }
      
      async function carregarParcelas(lancamentoId) {
        const contentDiv = document.getElementById(`parcelas-content-${lancamentoId}`);
        
        try {
          const res = await fetch(`${API_BASE}/api/lancamentos/${lancamentoId}/parcelas`, {
            credentials: 'include'
          });
          if (!res.ok) throw new Error('Erro ao carregar parcelas');
          
          const parcelas = await res.json();
          
          if (!parcelas || parcelas.length === 0) {
            contentDiv.innerHTML = '<p style="color:var(--muted); margin:0">Nenhuma parcela encontrada.</p>';
            return;
          }
          
          const parcelasHtml = parcelas.map(p => `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:var(--card); border-radius:8px; margin-bottom:8px">
              <div style="flex:1">
                <span style="font-weight:600; color:${p.paga ? '#22c55e' : 'var(--text)'}">
                  Parcela ${p.numero_parcela}
                </span>
                <span style="color:var(--muted); margin-left:12px">
                  Venc: ${formatarDataBR(p.data_vencimento)}
                </span>
              </div>
              <div style="flex:1; text-align:center">
                <span style="font-weight:600">${brl.format(p.valor)}</span>
                ${p.paga && p.valor_pago ? `<br><span style="font-size:12px; color:var(--muted)">Pago: ${brl.format(p.valor_pago)}</span>` : ''}
              </div>
              <div style="flex:1; text-align:center">
                ${p.paga ? 
                  `<span style="display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600; background:rgba(34,197,94,0.15); color:#22c55e">
                    ‚úì Paga em ${formatarDataBR(p.data_pagamento)}
                  </span>` : 
                  `<span style="display:inline-block; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600; background:rgba(239,68,68,0.15); color:#ef4444">
                    ‚óã A pagar
                  </span>`
                }
              </div>
              <div style="flex:0 0 auto; text-align:right">
                ${!p.paga ? 
                  `<button data-action="abrirModalEdicaoParcela" data-args='[${p.id}, "${p.data_vencimento}", ${p.valor}]' style="padding:6px 14px; margin-right:6px; border:none; border-radius:6px; background:rgba(59,130,246,0.15); color:#3b82f6; cursor:pointer; font-size:12px; font-weight:600" title="Editar parcela">
                    ‚úèÔ∏è Editar
                  </button>
                  <button data-action="abrirModalPagamento" data-args='[${p.id}, ${p.valor}]' style="padding:6px 14px; border:none; border-radius:6px; background:rgba(34,197,94,0.15); color:#22c55e; cursor:pointer; font-size:12px; font-weight:600" title="Marcar como paga">
                    üí∞ Pagar
                  </button>` :
                  `<button data-action="desmarcarPaga" data-args='[${p.id}, ${lancamentoId}]' style="padding:6px 14px; border:none; border-radius:6px; background:rgba(239,68,68,0.15); color:#ef4444; cursor:pointer; font-size:12px" title="Desmarcar como paga">
                    ‚úó
                  </button>`
                }
              </div>
            </div>
          `).join('');
          
          contentDiv.innerHTML = parcelasHtml;
        } catch (err) {
          console.error('Erro ao carregar parcelas:', err);
          contentDiv.innerHTML = '<p style="color:#ef4444; margin:0">Erro ao carregar parcelas.</p>';
        }
      }
      
      async function abrirModalPagamento(parcelaId, valorOriginal) {
        PromptDialog.show({
          title: 'üìÖ Data de pagamento',
          message: 'Informe a data em que a parcela foi paga:',
          type: 'date',
          defaultValue: todayISO(),
          required: true,
          onConfirm: (dataPagamento) => {
            // Agora pedir o valor
            PromptDialog.show({
              title: 'üí∞ Valor pago',
              message: 'Informe o valor efetivamente pago:',
              type: 'number',
              defaultValue: valorOriginal.toFixed(2),
              placeholder: '0.00',
              required: true,
              onConfirm: (valorPago) => {
                marcarParcelaPaga(parcelaId, dataPagamento, parseFloat(valorPago));
              }
            });
          }
        });
      }
      
      async function marcarParcelaPaga(parcelaId, dataPagamento, valorPago) {
        try {
          const res = await fetch(`${API_BASE}/api/parcelas/${parcelaId}/pagar`, {
            method: 'PATCH',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              paga: true,
              data_pagamento: dataPagamento,
              valor_pago: valorPago
            })
          });
          
          if (!res.ok) throw new Error('Erro ao marcar parcela como paga');
          
          showToast('Parcela marcada como paga!', 'success');
          
          // Recarregar parcelas da linha que est√° aberta
          const parcelaObj = await res.json();
          await carregarParcelas(parcelaObj.lancamento_id);
        } catch (err) {
          console.error('Erro:', err);
          showToast('Erro: ' + err.message, 'error');
        }
      }
      
      async function desmarcarPaga(parcelaId, lancamentoId) {
        ConfirmDialog.show({
          title: 'Desmarcar parcela',
          message: 'Deseja desmarcar esta parcela como paga?',
          confirmText: 'Desmarcar',
          cancelText: 'Cancelar',
          variant: 'danger',
          onConfirm: async () => {
            try {
              await fetchWithLoading(`${API_BASE}/api/parcelas/${parcelaId}/pagar`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paga: false })
              }, 'Atualizando...');
              Toast.success('Parcela desmarcada!');
              await carregarParcelas(lancamentoId);
            } catch (err) {
              console.error('Erro:', err);
              Toast.error('Erro: ' + err.message);
            }
          }
        });
      }

      async function abrirModalEdicaoParcela(parcelaId, dataVencimento, valorAtual) {
        PromptDialog.show({
          title: 'üìÖ Nova data de vencimento',
          message: 'Informe a nova data de vencimento da parcela:',
          type: 'date',
          defaultValue: dataVencimento,
          required: true,
          onConfirm: (novaData) => {
            // Agora pedir o novo valor
            PromptDialog.show({
              title: 'üí∞ Novo valor',
              message: 'Informe o novo valor da parcela:',
              type: 'number',
              defaultValue: parseFloat(valorAtual).toFixed(2),
              placeholder: '0.00',
              required: true,
              onConfirm: async (novoValor) => {
                try {
                  const parcelaObj = await fetchWithLoading(`${API_BASE}/api/parcelas/${parcelaId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      data_vencimento: novaData,
                      valor: parseFloat(novoValor)
                    })
                  }, 'Atualizando parcela...');
                  Toast.success('Parcela editada com sucesso!');
                  // Recarregar parcelas da linha que est√° aberta
                  await carregarParcelas(parcelaObj.lancamento_id);
                } catch (err) {
                  console.error('Erro:', err);
                  Toast.error('Erro: ' + err.message);
                }
              }
            });
          }
        });
      }

      // Inicializa lista
      refreshList();

      // ============================================
      // ATALHOS DE TECLADO
      // ============================================
      KeyboardShortcuts.register('ctrl+n', () => {
        btnZerar.click();
        dataLancEl.focus();
      }, 'Novo lan√ßamento');

      KeyboardShortcuts.register('ctrl+s', (e) => {
        e.preventDefault();
        if (!btnSubmit.disabled) {
          btnSubmit.click();
        }
      }, 'Salvar lan√ßamento');

      KeyboardShortcuts.register('ctrl+l', () => {
        refreshList();
        Toast.show('Lista atualizada!', 'info');
      }, 'Atualizar lista');
      
      // Event listeners est√°ticos (CSP compliance)
      document.getElementById('btnExportarExcel')?.addEventListener('click', exportarLancamentosExcel);
      
      // Expor fun√ß√µes no escopo global para events.js
      window.toggleFiltros = toggleFiltros;
      window.limparFiltros = limparFiltros;
      window.aplicarFiltros = aplicarFiltros;
      window.atualizarTiposLancamento = atualizarTiposLancamento;
      window.atualizarFiltroTipos = atualizarFiltroTipos;
      window.atualizarFiltroSubtipos = atualizarFiltroSubtipos;
      window.toggleParcelas = toggleParcelas;
      window.editarLancamento = editarLancamento;
      window.excluirLancamento = excluirLancamento;
      window.abrirModalEdicaoParcela = abrirModalEdicaoParcela;
      window.abrirModalPagamento = abrirModalPagamento;
      window.desmarcarPaga = desmarcarPaga;
    </script>
  </body>
</html>